<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />

    <meta charset="utf-8" />
    <link rel="icon" href="public/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <title>Login with BioCertica demo</title>

    <meta
      name="biocertica-signin-workspace-id"
      content="d916027f-2f42-4b38-b2aa-b9eecb1dd50d"
    />
    <meta name="biocertica-signin-secret" content="K6UgCphXgXEf66" />
    <script
      src="https://biocertica-api.s3.af-south-1.amazonaws.com/js/integration-snippet-dev.js"
      async
      defer
    ></script>
    <!--<script src="../../knowu-dna/integration-snippet/integration-snippet.js" async defer></script>-->
    <script>
      function parseJwt(token) {
        var base64Url = token.split(".")[1];
        var base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        var jsonPayload = decodeURIComponent(
          atob(base64)
            .split("")
            .map(function (c) {
              return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
            })
            .join("")
        );

        return JSON.parse(jsonPayload);
      }

      async function loader() {
        window.bapi.pollingInProgress
          ? document.getElementById("loader").classList.remove("hide")
          : document.getElementById("loader").classList.add("hide");
        setTimeout(loader, 100);
      }

      setTimeout(async () => {
        await window.bapi.getProfile();
        loader();
        if (window.bapi.profile === undefined) {
          document.getElementById("btn-kit").style.visibility = "visible";
          document.getElementById("btn-email").style.visibility = "visible";
          document.getElementById("btn-phone-number").style.visibility =
            "visible";
          document.getElementById("btn-oauth").style.visibility = "visible";
          document.getElementById("user-profile").style.visibility = "hidden";
          document.getElementById("geneticBtn").style.visibility = "hidden";
          document.getElementById("ancestryBtn").style.visibility = "hidden";
          document.getElementById("nutritionBtn").style.visibility = "hidden";
          document.getElementById("btn-logout").style.visibility = "hidden";
        } else {
          document.getElementById("btn-kit").style.visibility = "hidden";
          document.getElementById("btn-email").style.visibility = "hidden";
          document.getElementById("btn-phone-number").style.visibility =
            "hidden";
          document.getElementById("btn-oauth").style.visibility = "hidden";
          document.getElementById("btn-logout").style.visibility = "visible";
          document.getElementById("user-profile").style.visibility = "visible";
          document.getElementById("firstName").innerText =
            "First name: " + window.bapi.profile.firstName;
          document.getElementById("lastName").innerText =
            "Last name: " + window.bapi.profile.lastName;
          document.getElementById("accessemail").innerText =
            "Email: " + window.bapi.profile.email;
          document.getElementById("phoneNumber").innerText =
            "Phone number: " + window.bapi.profile.phoneNumber;
          document.getElementById("accessToken").innerText =
            "Access Token: " + localStorage.getItem("biocerticaAccessToken");
          document.getElementById("refreshToken").innerText =
            "Refresh Token: " + localStorage.getItem("biocerticaRefreshToken");
          document.getElementById("scope").innerText =
            "You agreed to share: " +
            parseJwt(localStorage.getItem("biocerticaAccessToken")).scope;
          document.getElementById("email").innerText =
            "Email: " +
            parseJwt(localStorage.getItem("biocerticaAccessToken")).email;

          // document
          //   .getElementById("geneticBtn")
          //   .addEventListener("click", async function () {
          //     await bapi.getGenetic();
          //     document.getElementById("field").innerText =
          //       "Genetic results: " + JSON.stringify(window.bapi.genetic);
          //   });

          // document
          //   .getElementById("ancestryBtn")
          //   .addEventListener("click", async function () {
          //     await bapi.getAncestry();
          //     document.getElementById("field").innerText =
          //       "Ancestry results: " + JSON.stringify(window.bapi.ancestry);
          //   });

          // document
          //   .getElementById("nutritionBtn")
          //   .addEventListener("click", async function () {
          //     await bapi.getNutrition();
          //     document.getElementById("field").innerText =
          //       "Nutrition results: " + JSON.stringify(window.bapi.nutrition);
          //   });
          document
            .getElementById("recommendation")
            .addEventListener("click", async function () {
              await bapi.getGenetic();
              document.getElementById("img-id").src =
                window.bapi.genetic[0].scoreCategory == 0
                  ? "./public/low.png"
                  : window.bapi.genetic[0].scoreCategory == 1
                  ? "./public/normal.png"
                  : window.bapi.genetic[0].scoreCategory == 2
                  ? "./public/high.png"
                  : "No Vitamin A Results";
              document.getElementById("vitaminA").innerText =
                window.bapi.genetic[0].scoreCategory == 0
                  ? "Shake with high levels of Vitamin A"
                  : window.bapi.genetic[0].scoreCategory == 1
                  ? "Shake with average levels of Vitamin A"
                  : window.bapi.genetic[0].scoreCategory == 2
                  ? "Shake with low levels of Vitamin A"
                  : "No Vitamin A Results";
            });
        }
      }, 2000);
    </script>
  </head>

  <body>
    <div class="container">
      <noscript>You need to enable JavaScript to run this app.</noscript>
      <div class="row">
        <div id="btn-email" class="col s12">
          <div class="section row">
            <div class="input-field col s8">
              <input id="bio-login-email" type="email" class="validate" />
              <label for="bio-login-email">Email</label>
            </div>
            <button
              class="waves-effect waves-light btn col s4"
              id="bio-login-email-button"
              onclick="bapi.loginWithEmail(document.getElementById('bio-login-email').value)"
            >
              Login with Email
            </button>
          </div>
        </div>

        <div class="divider"></div>

        <div id="btn-phone-number" class="col s12">
          <div class="section row">
            <div class="input-field col s8">
              <input id="bio-login-phone-number" type="tel" class="validate" />
              <label for="bio-login-phone-number">Phone</label>
            </div>
            <button
              class="waves-effect waves-light btn col s4"
              id="bio-login-phone-number-button"
              onclick="bapi.loginWithPhoneNumber(document.getElementById('bio-login-phone-number').value)"
            >
              Login with Phone Number
            </button>
          </div>
        </div>

        <div class="divider"></div>

        <div id="btn-kit" class="col s12">
          <div class="section row">
            <div class="input-field col s8">
              <input id="bio-login-kit" type="text" class="validate" />
              <label for="bio-login-kit">BioCertica ID</label>
            </div>
            <button
              class="waves-effect waves-light btn col s4"
              id="bio-login-kit-button"
              onclick="bapi.loginWithKitID(document.getElementById('bio-login-kit').value)"
            >
              Login with BioCertica ID
            </button>
          </div>
        </div>

        <div class="divider"></div>

        <div id="btn-oauth" class="col s12">
          <div id="bio-signin-biocertica" />
        </div>

        <div class="divider"></div>

        <div id="loader" class="progress">
          <div class="indeterminate"></div>
        </div>

        <div id="user-profile" class="col s12">
          <div class="section row">
            <div class="col s12">
              Token Information:
              <div class="divider"></div>
              <div id="accessToken" class="col s12"></div>
              <div id="refreshToken" class="col s12"></div>
              <div id="accessemail" class="col s12"></div>
              <div id="scope" class="col s12"></div>
              <div class="divider"></div>
            </div>
          </div>

          <div class="section row">
            <div class="col s12">
              Profile Information:
              <div class="divider"></div>
              <div id="firstName" class="col s12"></div>
              <div id="lastName" class="col s12"></div>
              <div id="email" class="col s12"></div>
              <div id="phoneNumber" class="col s12"></div>
              <div class="divider"></div>
            </div>
          </div>

          <div class="section row">
            <button
              id="recommendation"
              class="waves-effect waves-light btn col s2"
            >
              Recommend
            </button>

            <div class="col s12">
              Based on your Vitamin A results we can recommend this smoothie:
            </div>

            <div id="vitaminA" class="col s12"></div>
            <img id="img-id" src="" height="400" />
          </div>
<!--
          <div class="section row">
            <div class="col s12">
              <button
                id="geneticBtn"
                class="waves-effect waves-light btn col s2"
              >
                Get Genetic
              </button>
              <button
                id="ancestryBtn"
                class="waves-effect waves-light btn col s2"
              >
                Get Ancestry
              </button>
              <button
                id="nutritionBtn"
                class="waves-effect waves-light btn col s2"
              >
                Get Nutrition
              </button>
-->
              <button
                id="btn-logout"
                class="waves-effect waves-light btn col s2"
                onclick="bapi.logout()"
              >
                Logout
              </button>
              <div id="field" class="col s12"></div>
            </div>
          </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
      </div>
    </div>
  </body>
</html>
